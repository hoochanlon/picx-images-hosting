name: Deploy to gh-pages

on:
  push:
    branches:
      - master   # 或 main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      # 生成 index.html 文件，带有固定导航栏，不包含分页
      - name: Generate index.html files with fixed navbar
        run: |
          echo "Generating index.html files for directories"
          find . -type d -not -path '*/.git/*' -exec bash -c '
            DIR="{}"
            INDEX="$DIR/index.html"

            # 如果目录不为空
            if [ "$(ls -A "$DIR")" ]; then
              echo "<!DOCTYPE html><html lang=\"en\"><head><meta charset=\"UTF-8\"><title>Index of $DIR</title>" > "$INDEX"
              echo "<style>body { font-family: Arial, sans-serif; }</style>" >> "$INDEX"
              echo "</head><body>" >> "$INDEX"

              # 固定导航栏
              echo "<div style=\"position: fixed; top: 0; left: 0; width: 100%; background-color: #f4f4f4; padding: 10px; border-bottom: 1px solid #ccc; z-index: 100;\">" >> "$INDEX"
              echo "<a href=\"../\">.. (Go Up)</a>" >> "$INDEX"
              echo "</div>" >> "$INDEX"

              # 页面内容
              echo "<div style=\"margin-top: 60px;\">" >> "$INDEX"
              echo "<h1>Index of $DIR</h1>" >> "$INDEX"
              echo "<ul>" >> "$INDEX"

              # 列出目录下的文件（排除 index.html 自己）
              for file in "$DIR"/*; do
                base=$(basename "$file")
                if [ -f "$file" ] && [ "$base" != "index.html" ]; then
                  echo "<li><a href=\"/$DIR/$base\">$base</a></li>" >> "$INDEX"  # 绝对路径
                elif [ -d "$file" ]; then
                  echo "<li><a href=\"/$DIR/$base/\">$base/</a></li>" >> "$INDEX"  # 绝对路径
                fi
              done

              echo "</ul>" >> "$INDEX"

              # 底部显示 index.html 和 Go Up
              echo "<hr>" >> "$INDEX"
              echo "<div style=\"margin-top:20px;\">" >> "$INDEX"
              echo "<a href=\"index.html\">index.html</a><br>" >> "$INDEX"
              echo "<a href=\"../\">.. (Go Up)</a>" >> "$INDEX"
              echo "</div></body></html>" >> "$INDEX"
            fi
          ' \;

      # 设置 SSH 以部署
      - name: Set up SSH
        uses: webfactory/ssh-agent@v0.5.3
        with:
          ssh-private-key: ${{ secrets.DEPLOY_KEY }}

      # 部署到 gh-pages
      - name: Deploy to gh-pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          deploy_key: ${{ secrets.DEPLOY_KEY }}
          publish_branch: gh-pages
          publish_dir: ./
