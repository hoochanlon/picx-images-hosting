name: Deploy to gh-pages

on:
  push:
    branches:
      - master

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Generate index.html files (with image preview)
        run: |
          echo "Generating index.html with image previews"

          find . -type d -not -path '*/.git/*' -exec bash -c '
            DIR="{}"

            # åˆ›å»º index.html
            cat > "$DIR/index.html" <<EOF
<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<title>Index of $DIR</title>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/baguettebox.js@1.11.1/dist/baguetteBox.min.css">
<style>
body { font-family: sans-serif; padding: 20px; }
ul { line-height: 1.8; }
.gallery img { height: 120px; margin: 5px; border-radius: 6px; }
</style>
</head>
<body>

EOF

            # è¿”å›ä¸Šå±‚
            if [ "$DIR" != "." ]; then
              echo "<a href=\"../\">â¬† è¿”å›ä¸Šä¸€å±‚</a><br><br>" >> "$DIR/index.html"
            fi

            echo "<h2>Index of $DIR</h2>" >> "$DIR/index.html"
            echo "<ul>" >> "$DIR/index.html"

            # éå†æ–‡ä»¶å¤¹
            for f in "$DIR"/*; do
              fname=$(basename "$f")
              # å­ç›®å½•
              if [ -d "$f" ]; then
                echo "<li><a href=\"$fname/\">ğŸ“ $fname/</a></li>" >> "$DIR/index.html"
              # å›¾ç‰‡æ–‡ä»¶
              elif [[ "$fname" =~ \.(png|jpg|jpeg|gif|webp)$ ]]; then
                echo "<a class=\"gallery\" href=\"$fname\"><img src=\"$fname\"></a>" >> "$DIR/index.html"
              # æ™®é€šæ–‡ä»¶
              else
                echo "<li><a href=\"$fname\">ğŸ“„ $fname</a></li>" >> "$DIR/index.html"
              fi
            done

            echo "</ul>" >> "$DIR/index.html"

            cat >> "$DIR/index.html" <<EOF
<script src="https://cdn.jsdelivr.net/npm/baguettebox.js@1.11.1/dist/baguetteBox.min.js"></script>
<script>baguetteBox.run('.gallery');</script>
</body></html>
EOF

          ' \;

      - name: Set up SSH
        uses: webfactory/ssh-agent@v0.5.3
        with:
          ssh-private-key: ${{ secrets.DEPLOY_KEY }}

      - name: Deploy to gh-pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          deploy_key: ${{ secrets.DEPLOY_KEY }}
          publish_branch: gh-pages
          publish_dir: ./
