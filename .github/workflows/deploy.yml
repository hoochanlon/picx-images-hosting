name: Deploy to gh-pages

on:
  push:
    branches:
      - master

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Generate index.html for all directories
        run: |
          echo "Generating index.html for all directories..."

          find . -type d -not -path '*/.git/*' -exec bash -c '
            DIR="{}"
            INDEX="$DIR/index.html"

            echo "<!DOCTYPE html><html lang=\"en\"><head><meta charset=\"UTF-8\">" > "$INDEX"
            echo "<title>Index of $DIR</title>" >> "$INDEX"
            echo "<style>
              body { font-family: Arial, sans-serif; line-height: 1.8; padding: 0 20px; }
              ul { list-style: none; padding-left: 0; }
              li { margin: 4px 0; }
              a { text-decoration: none; color: #0070f3; }
              a:hover { text-decoration: underline; }

              /* È°∂ÈÉ®ÂØºËà™Ê†è */
              .topbar {
                position: fixed;
                top: 0; left: 0;
                width: 100%;
                background: #f0f0f0;
                border-bottom: 1px solid #ccc;
                padding: 10px 20px;
                z-index: 100;
              }
              .container { margin-top: 70px; }

              /* ÂõæÊ†á */
              .file::before {
                content: \"üìÑ \";
              }
              .folder::before {
                content: \"üìÅ \";
              }
            </style>" >> "$INDEX"

            echo "</head><body>" >> "$INDEX"

            # ========== È°∂ÈÉ®ÂØºËà™ÔºàÂõ∫ÂÆöÔºâ ==========
            echo "<div class=\"topbar\">" >> "$INDEX"
            echo "<strong>üìÇ Index Navigation:</strong> " >> "$INDEX"
            echo "<a href=\"./index.html\">Home</a>" >> "$INDEX"

            if [ \"$DIR\" != \".\" ]; then
              echo " | <a href=\"../\">‚¨Ü Go Up</a>" >> "$INDEX"
            fi

            echo "</div>" >> "$INDEX"

            # È°µÈù¢ÂÜÖÂÆπ
            echo "<div class=\"container\">" >> "$INDEX"
            echo "<h2>Index of $DIR</h2>" >> "$INDEX"
            echo "<ul>" >> "$INDEX"

            for file in \"$DIR\"/*; do
              base=$(basename \"$file\")
              [ \"$base\" = \"index.html\" ] && continue

              if [ -d \"$file\" ]; then
                echo "<li class=\"folder\"><a href=\"$base/\">$base/</a></li>" >> "$INDEX"
              elif [ -f \"$file\" ]; then
                echo "<li class=\"file\"><a href=\"$base\">$base</a></li>" >> "$INDEX"
              fi
            done

            echo "</ul>" >> "$INDEX"
            echo "</div></body></html>" >> "$INDEX"

          ' \;

      - name: Set up SSH
        uses: webfactory/ssh-agent@v0.5.3
        with:
          ssh-private-key: ${{ secrets.DEPLOY_KEY }}

      - name: Deploy to gh-pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          deploy_key: ${{ secrets.DEPLOY_KEY }}
          publish_branch: gh-pages
          publish_dir: ./
