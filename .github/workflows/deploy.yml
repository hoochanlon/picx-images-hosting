name: Deploy to gh-pages

on:
  push:
    branches:
      - master   # æˆ– main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      # ç”Ÿæˆ index.htmlï¼ˆæ— åˆ†é¡µ + é¡¶éƒ¨å¯¼èˆª + æ–‡ä»¶åˆ—è¡¨ï¼‰
      - name: Generate index.html for all directories
        run: |
          echo "Generating index.html..."

          find . -type d -not -path '*/.git/*' -exec bash -c '
            DIR="{}"
            INDEX="$DIR/index.html"

            echo "<!DOCTYPE html><html lang=\"en\"><head><meta charset=\"UTF-8\">" > "$INDEX"
            echo "<title>Index of $DIR</title>" >> "$INDEX"

            echo "<style>
              body { font-family: Arial, sans-serif; line-height: 1.7; padding: 0 20px; }
              ul { list-style: none; padding-left: 0; }
              li { margin: 5px 0; }
              a { color: #0366d6; text-decoration: none; }
              a:hover { text-decoration: underline; }

              /* é¡¶éƒ¨å›ºå®šå¯¼èˆªæ  */
              .topbar {
                position: fixed;
                top: 0; left: 0;
                width: 100%;
                background: #f7f7f7;
                border-bottom: 1px solid #ccc;
                padding: 12px 20px;
                z-index: 1000;
              }

              .container { margin-top: 75px; }

              /* å›¾æ ‡ */
              .file::before   { content: \"ğŸ“„ \"; }
              .folder::before { content: \"ğŸ“ \"; }
            </style>" >> "$INDEX"

            echo "</head><body>" >> "$INDEX"

            # é¡¶éƒ¨å¯¼èˆª
            echo "<div class=\"topbar\">" >> "$INDEX"
            echo "<strong>ğŸ“‚ Index Navigation:</strong> " >> "$INDEX"
            echo "<a href=\"./index.html\">Home</a>" >> "$INDEX"

            if [ \"$DIR\" != \".\" ]; then
              echo " | <a href=\"../\">â¬† Go Up</a>" >> "$INDEX"
            fi

            echo "</div>" >> "$INDEX"

            # å†…å®¹
            echo "<div class=\"container\">" >> "$INDEX"
            echo "<h2>Index of $DIR</h2>" >> "$INDEX"
            echo "<ul>" >> "$INDEX"

            # âš  æ­£ç¡®å±•å¼€æ–‡ä»¶åˆ—è¡¨ â€”â€” ä¸åŠ å¼•å·ï¼
            for file in $DIR/*; do
              base=$(basename "$file")

              # è·³è¿‡è‡ªèº«
              [ "$base" = "index.html" ] && continue

              if [ -d "$file" ]; then
                echo "<li class=\"folder\"><a href=\"$base/\">$base/</a></li>" >> "$INDEX"
              elif [ -f "$file" ]; then
                echo "<li class=\"file\"><a href=\"$base\">$base</a></li>" >> "$INDEX"
              fi
            done

            echo "</ul>" >> "$INDEX"
            echo "</div></body></html>" >> "$INDEX"

          ' \;

      - name: Set up SSH
        uses: webfactory/ssh-agent@v0.5.3
        with:
          ssh-private-key: ${{ secrets.DEPLOY_KEY }}

      - name: Deploy to gh-pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          deploy_key: ${{ secrets.DEPLOY_KEY }}
          publish_branch: gh-pages
          publish_dir: ./
