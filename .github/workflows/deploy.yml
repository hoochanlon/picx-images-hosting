name: Deploy to gh-pages

on:
  push:
    branches:
      - master  # 或者 main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      # 生成带有“当前文件夹”和“上一层目录”链接的 index.html 文件
      - name: Generate index.html files
        run: |
          echo "Generating index.html files for directories"
          find . -type d -not -path '*/.git/*' -exec bash -c '
            DIR="{}"
            if [ "$(ls -A "$DIR")" ]; then
              # 创建目录的 index.html 文件
              echo "<!DOCTYPE html><html lang=\"en\"><head><meta charset=\"UTF-8\"><title>Index of $DIR</title></head><body>" > $DIR/index.html
              # 添加返回上一层目录的链接
              if [ "$DIR" != "." ]; then
                echo "<a href=\"../\">.. (Go Up)</a><br>" >> $DIR/index.html
              fi
              # 当前目录链接
              echo "<h1>Index of $DIR</h1>" >> $DIR/index.html
              echo "<ul>" >> $DIR/index.html
              # 列出目录下的文件
              for file in $DIR/*; do
                if [ -f "$file" ]; then
                  echo "<li><a href=\"$(basename "$file")\">$(basename "$file")</a></li>" >> $DIR/index.html
                fi
              done
              echo "</ul>" >> $DIR/index.html
              echo "</body></html>" >> $DIR/index.html
            fi
          ' \;

      # 设置 SSH 密钥以便部署到 gh-pages
      - name: Set up SSH
        uses: webfactory/ssh-agent@v0.5.3
        with:
          ssh-private-key: ${{ secrets.DEPLOY_KEY }}  # 引用 GitHub Secrets 中的私钥

      # 部署到 gh-pages 分支
      - name: Deploy to gh-pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          deploy_key: ${{ secrets.DEPLOY_KEY }}  # 这里使用 GitHub Secrets 中的私钥
          publish_branch: gh-pages  # 发布到 gh-pages 分支
          publish_dir: ./  # 部署根目录下的所有内容，或你构建的目录
