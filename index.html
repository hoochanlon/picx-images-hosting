<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>picx-images-hosting - é™æ€ç´¢å¼•</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
  <link rel="stylesheet" href="./style.css" />
</head>
<body>
  <header class="topbar">
    <div class="brand">
      <span class="emoji">ğŸ–¼ï¸</span>
      <span class="title">picx-images-hosting</span>
    </div>
    <div class="desc">æ— éœ€è„šæœ¬ç”Ÿæˆï¼Œç›´æ¥éƒ¨ç½² GitHub Pagesã€‚å›¾ç‰‡åŒæ—¶æä¾› Pages ä¸ jsDelivr é“¾æ¥ã€‚</div>
    <div class="controls">
      <label for="folder">ç›®å½•ï¼š</label>
      <select id="folder">
        <option value="ALL">å…¨éƒ¨ç›®å½•</option>
      </select>
      <label for="filter">æœç´¢æ–‡ä»¶åï¼š</label>
      <input id="filter" type="search" placeholder="è¾“å…¥å…³é”®è¯è¿‡æ»¤" />
      <button id="reset-filter" type="button">æ¸…ç©º</button>
      <button id="open-upload" type="button">ä¸Šä¼ </button>
      <button id="reload-btn" type="button">åˆ·æ–°åˆ—è¡¨</button>
    </div>
  </header>

  <main class="container">
    <section id="status" class="status">æ­£åœ¨åŠ è½½ä»“åº“æ ‘...</section>
    <section id="grid" class="grid" aria-live="polite"></section>
  </main>

  <div id="lightbox" class="lightbox hidden" aria-modal="true" role="dialog">
    <div class="lightbox-backdrop" data-close></div>
    <div class="lightbox-body">
      <button class="lightbox-close lightbox-control-btn" aria-label="å…³é—­" data-close>Ã—</button>
      <div class="lightbox-img-wrap">
        <button class="lightbox-nav prev lightbox-control-btn" aria-label="ä¸Šä¸€å¼ ">â†</button>
        <img id="lightbox-img" alt="é¢„è§ˆå¤§å›¾" />
        <button class="lightbox-nav next lightbox-control-btn" aria-label="ä¸‹ä¸€å¼ ">â†’</button>
      </div>
      <div class="lightbox-zoom">
        <button id="toggle-controls" type="button" aria-label="åˆ‡æ¢æ§åˆ¶æŒ‰é’®"><i class="fas fa-eye-slash lightbox-icon-outline"></i></button>
        <button id="info-btn" class="lightbox-control-btn" type="button" aria-label="å›¾ç‰‡ä¿¡æ¯"><i class="fas fa-info-circle lightbox-icon-outline"></i></button>
        <button id="fullscreen-toggle" class="lightbox-control-btn" type="button" aria-label="å…¨å±åˆ‡æ¢">â›¶</button>
        <button id="zoom-reset" class="lightbox-control-btn" type="button">1:1</button>
        <button id="rotate" class="lightbox-control-btn" type="button">âŸ³</button>
      </div>
      <div id="lightbox-info" class="lightbox-info hidden" aria-live="polite">
        <div class="lightbox-info-title">å›¾ç‰‡ä¿¡æ¯</div>
        <div id="lightbox-info-content" class="lightbox-info-code"></div>
      </div>
    </div>
  </div>

  <div id="upload-modal" class="upload-modal hidden" aria-modal="true" role="dialog">
    <div class="upload-modal-backdrop" data-close-upload></div>
    <div class="upload-modal-content">
      <div class="upload-modal-header">
        <h2>ä¸Šä¼ æ–‡ä»¶</h2>
        <button class="upload-modal-close" aria-label="å…³é—­" data-close-upload>Ã—</button>
      </div>
      <div class="upload-modal-body">
        <div class="upload-form-group">
          <label for="upload-file">é€‰æ‹©æ–‡ä»¶ï¼š</label>
          <input id="upload-file" type="file" multiple />
          <div id="upload-file-list" class="upload-file-list"></div>
        </div>
        <div class="upload-form-group">
          <label for="upload-path">ä¿å­˜åˆ°ï¼š</label>
          <input id="upload-path" type="text" placeholder="ä¾‹å¦‚ imgs/2025/" />
          <p class="upload-tip">è·¯å¾„ç•™ç©ºé»˜è®¤å­˜å…¥ <span id="default-path-display">imgs/uploads/kate/</span></p>
        </div>
        <div class="upload-form-group">
          <label for="default-upload-path">è®¾ç½®é»˜è®¤è·¯å¾„ï¼š</label>
          <div class="default-path-setting">
            <input id="default-upload-path" type="text" placeholder="ä¾‹å¦‚ imgs/uploads/kate/" />
            <button id="save-default-path" type="button" class="btn-secondary">ä¿å­˜</button>
          </div>
          <p class="upload-tip">è®¾ç½®åï¼Œä¸‹æ¬¡ä¸Šä¼ æ—¶è·¯å¾„ç•™ç©ºå°†ä½¿ç”¨æ­¤é»˜è®¤è·¯å¾„</p>
        </div>
        <div class="upload-form-group">
          <p class="upload-tip">æ–‡ä»¶ç» Vercel Serverless è°ƒç”¨ GitHub APIï¼Œå‰ç«¯ä¸å­˜ tokenã€‚</p>
        </div>
      </div>
      <div class="upload-modal-footer">
        <button id="upload-btn" type="button" class="btn-primary">ä¸Šä¼ </button>
        <button id="cancel-upload" type="button" class="btn-secondary" data-close-upload>å–æ¶ˆ</button>
      </div>
    </div>
  </div>

  <template id="card-template">
    <article class="card">
      <div class="meta-top">
        <div class="path" title=""></div>
      </div>
      <div class="thumb">
        <img loading="lazy" alt="" />
      </div>
      <div class="meta">
        <div class="actions-row">
          <button class="btn" type="button" data-copy="pages">é“¾æ¥å¤åˆ¶</button>
          <button class="btn" type="button" data-copy="cdn">CDN å¤åˆ¶</button>
          <button class="btn danger delete-btn" type="button">åˆ é™¤</button>
        </div>
      </div>
    </article>
  </template>

  <script>
    const REPO_OWNER = 'hoochanlon';
    const REPO_NAME = 'picx-images-hosting';
    const BRANCH = 'master';
    const PAGES_BASE = `https://${REPO_OWNER}.github.io/${REPO_NAME}`;
    const CDN_BASE = `https://cdn.jsdelivr.net/gh/${REPO_OWNER}/${REPO_NAME}@${BRANCH}`;
    const IMAGE_EXT = /\.(jpe?g|png|gif|webp|svg)$/i;
    const EXCLUDES = ['.git/', '.github/'];
    const API_BASE = 'https://picx-images-hosting-brown.vercel.app';
    const API_ENDPOINT = `${API_BASE}/api/github`;
    const DEFAULT_DIR = 'imgs/uploads/kate/';

    const statusEl = document.getElementById('status');
    const gridEl = document.getElementById('grid');
    const filterInput = document.getElementById('filter');
    const folderSelect = document.getElementById('folder');
    const resetBtn = document.getElementById('reset-filter');
    const infoBtn = document.getElementById('info-btn');
    const toggleControlsBtn = document.getElementById('toggle-controls');
    const cardTpl = document.getElementById('card-template');
    const lightboxEl = document.getElementById('lightbox');
    const lbImg = document.getElementById('lightbox-img');
    const infoPanel = document.getElementById('lightbox-info');
    const infoContent = document.getElementById('lightbox-info-content');
    const fullscreenBtn = document.getElementById('fullscreen-toggle');
    const zoomResetBtn = document.getElementById('zoom-reset');
    const rotateBtn = document.getElementById('rotate');
    const openUploadBtn = document.getElementById('open-upload');
    const uploadModal = document.getElementById('upload-modal');
    const uploadFileInput = document.getElementById('upload-file');
    const uploadPathInput = document.getElementById('upload-path');
    const uploadBtn = document.getElementById('upload-btn');
    const uploadFileList = document.getElementById('upload-file-list');
    const defaultUploadPathInput = document.getElementById('default-upload-path');
    const defaultPathDisplay = document.getElementById('default-path-display');
    const saveDefaultPathBtn = document.getElementById('save-default-path');
    const reloadBtn = document.getElementById('reload-btn');

    let images = [];
    let folders = [];
    let currentIndex = -1;
    let scale = 1;
    let rotation = 0;
    let translateX = 0;
    let translateY = 0;
    let isPanning = false;
    let panStartX = 0;
    let panStartY = 0;
    let isFullscreen = false;

    function applyTransform() {
      lbImg.style.transform = `translate(${translateX}px, ${translateY}px) scale(${scale}) rotate(${rotation}deg)`;
    }

    function resetTransform() {
      scale = 1;
      rotation = 0;
      translateX = 0;
      translateY = 0;
      applyTransform();
    }

    function setStatus(text, isError = false) {
      statusEl.textContent = text;
      statusEl.classList.toggle('error', isError);
    }

    function shouldSkip(path) {
      return EXCLUDES.some((ex) => path.startsWith(ex));
    }

    function getDefaultUploadPath() {
      const saved = localStorage.getItem('defaultUploadPath');
      return saved || DEFAULT_DIR;
    }

    function saveDefaultUploadPath(path) {
      if (path && path.trim()) {
        let normalizedPath = path.trim();
        if (!normalizedPath.endsWith('/')) normalizedPath += '/';
        localStorage.setItem('defaultUploadPath', normalizedPath);
        return normalizedPath;
      }
      return null;
    }

    function buildTargetPath(folderInput, fileName) {
      let base = (folderInput || '').trim();
      if (!base) base = getDefaultUploadPath();
      if (!base.endsWith('/')) base += '/';
      return `${base}${fileName}`;
    }

    async function toBase64(file) {
      const buffer = await file.arrayBuffer();
      const bytes = new Uint8Array(buffer);
      let binary = '';
      const chunk = 0x8000;
      for (let i = 0; i < bytes.length; i += chunk) {
        binary += String.fromCharCode(...bytes.subarray(i, i + chunk));
      }
      return btoa(binary);
    }

    async function apiRequest(payload) {
      const res = await fetch(API_ENDPOINT, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload),
      });
      if (!res.ok) {
        const text = await res.text();
        throw new Error(text || `API è¯·æ±‚å¤±è´¥: ${res.status}`);
      }
      return res.json();
    }

    async function fetchTree() {
      const url = `${API_BASE}/api/tree`;
      const res = await fetch(url);
      if (!res.ok) {
        const body = await res.json().catch(() => ({}));
        const hint = body.message || `HTTP ${res.status}`;
        throw new Error(`è·å–ä»“åº“æ ‘å¤±è´¥ï¼š${hint}`);
      }
      return res.json();
    }

    function buildCard(item) {
      const node = cardTpl.content.firstElementChild.cloneNode(true);
      const imgEl = node.querySelector('img');
      const pathEl = node.querySelector('.path');
      const pagesLink = document.createElement('a');
      pagesLink.href = `${PAGES_BASE}/${item.path}`;
      const cdnLink = document.createElement('a');
      cdnLink.href = `${CDN_BASE}/${item.path}`;
      const delBtn = node.querySelector('.delete-btn');
      const copyButtons = node.querySelectorAll('[data-copy]');

      imgEl.src = `${CDN_BASE}/${item.path}`;
      imgEl.alt = item.name;
      pathEl.textContent = item.name;
      pathEl.title = item.path;

      pagesLink.href = `${PAGES_BASE}/${item.path}`;
      cdnLink.href = `${CDN_BASE}/${item.path}`;

      imgEl.addEventListener('click', () => openLightbox(item.idx));
      node.addEventListener('click', (e) => {
        if (e.target.tagName === 'BUTTON' || e.target.tagName === 'A') return;
        openLightbox(item.idx);
      });

      copyButtons.forEach((btn) => {
        btn.addEventListener('click', () => {
          const type = btn.dataset.copy;
          const url = type === 'pages' ? pagesLink.href : cdnLink.href;
          navigator.clipboard.writeText(url);
          const old = btn.textContent;
          btn.textContent = 'å·²å¤åˆ¶';
          setTimeout(() => (btn.textContent = old), 1500);
        });
      });

      delBtn.addEventListener('click', async (e) => {
        e.stopPropagation();
        const ok = confirm(`ç¡®å®šåˆ é™¤æ–‡ä»¶ï¼š${item.path} å—ï¼Ÿæ­¤æ“ä½œä¼šæäº¤åˆ°ä»“åº“ã€‚`);
        if (!ok) return;
        try {
          setStatus('åˆ é™¤ä¸­...');
          await deleteFile(item.path);
          await loadImages(false);
          setStatus('åˆ é™¤å®Œæˆ');
        } catch (err) {
          console.error(err);
          setStatus(err.message || 'åˆ é™¤å¤±è´¥', true);
        }
      });

      return node;
    }

    function render(list) {
      gridEl.innerHTML = '';
      if (!list.length) {
        setStatus('æœªæ‰¾åˆ°åŒ¹é…çš„å›¾ç‰‡ï¼Œè¯·æ£€æŸ¥è¿‡æ»¤æ¡ä»¶ã€‚', true);
        return;
      }
      setStatus(`å…± ${list.length} å¼ å›¾ç‰‡ï¼Œå¯ç‚¹å‡»é¢„è§ˆä¸å¤åˆ¶é“¾æ¥ã€‚`);
      const frag = document.createDocumentFragment();
      list.forEach((item) => frag.appendChild(buildCard(item)));
      gridEl.appendChild(frag);
    }

    function applyFilter() {
      const keyword = filterInput.value.trim().toLowerCase();
      const folder = folderSelect.value;
      if (!keyword) {
        const base = folder === 'ALL' ? images : images.filter((img) => img.dir === folder);
        render(base);
        return;
      }
      const filtered = images
        .filter((img) => img.path.toLowerCase().includes(keyword))
        .filter((img) => (folder === 'ALL' ? true : img.dir === folder));
      render(filtered);
    }

    function openLightbox(idx) {
      if (idx < 0 || idx >= images.length) return;
      currentIndex = idx;
      const item = images[idx];
      const cdnUrl = `${CDN_BASE}/${item.path}`;

      lbImg.src = cdnUrl;
      resetTransform();

      lightboxEl.classList.remove('hidden');
      document.body.classList.add('lightbox-open');
      if (infoPanel) {
        infoPanel.classList.add('hidden');
      }
    }

    function closeLightbox() {
      lightboxEl.classList.add('hidden');
      currentIndex = -1;
      document.body.classList.remove('lightbox-open');
      if (infoPanel) {
        infoPanel.classList.add('hidden');
      }
      // é‡ç½®æ§åˆ¶æŒ‰é’®æ˜¾ç¤ºçŠ¶æ€
      lightboxEl.classList.remove('lightbox-controls-hidden');
      if (toggleControlsBtn) {
        const icon = toggleControlsBtn.querySelector('i');
        if (icon) {
          icon.className = 'fas fa-eye-slash lightbox-icon-outline';
        }
      }
    }

    function showPrev() {
      if (currentIndex <= 0) {
        openLightbox(images.length - 1);
        return;
      }
      openLightbox(currentIndex - 1);
    }

    function showNext() {
      if (currentIndex >= images.length - 1) {
        openLightbox(0);
        return;
      }
      openLightbox(currentIndex + 1);
    }

    function setupLightbox() {
      lightboxEl.addEventListener('click', (e) => {
        const target = e.target;
        if (
          target.dataset.close !== undefined ||
          target.classList.contains('lightbox-backdrop') ||
          target === lightboxEl
        ) {
          closeLightbox();
        }
      });
      lightboxEl.querySelector('.prev').addEventListener('click', (e) => {
        e.stopPropagation();
        showPrev();
      });
      lightboxEl.querySelector('.next').addEventListener('click', (e) => {
        e.stopPropagation();
        showNext();
      });
      lightboxEl.querySelector('.lightbox-close').addEventListener('click', (e) => {
        e.stopPropagation();
        closeLightbox();
      });

      document.addEventListener('keydown', (e) => {
        if (lightboxEl.classList.contains('hidden')) return;
        if (e.key === 'Escape') closeLightbox();
        if (e.key === 'ArrowLeft') showPrev();
        if (e.key === 'ArrowRight') showNext();
      });

      lbImg.addEventListener('wheel', (e) => {
        e.preventDefault();
        const delta = e.deltaY < 0 ? 0.1 : -0.1;
        scale = Math.min(5, Math.max(0.5, scale + delta));
        applyTransform();
      }, { passive: false });

      lbImg.addEventListener('dblclick', () => {
        scale = scale === 1 ? 2 : 1;
        translateX = 0;
        translateY = 0;
        applyTransform();
      });

      lbImg.addEventListener('mousedown', (e) => {
        if (scale <= 1) return;
        isPanning = true;
        panStartX = e.clientX - translateX;
        panStartY = e.clientY - translateY;
        e.preventDefault();
      });

      window.addEventListener('mousemove', (e) => {
        if (!isPanning) return;
        translateX = e.clientX - panStartX;
        translateY = e.clientY - panStartY;
        applyTransform();
      });

      window.addEventListener('mouseup', () => {
        isPanning = false;
      });

      zoomResetBtn.addEventListener('click', () => {
        resetTransform();
      });

      rotateBtn.addEventListener('click', () => {
        rotation = (rotation + 90) % 360;
        applyTransform();
      });

      fullscreenBtn.addEventListener('click', async () => {
        try {
          if (!document.fullscreenElement) {
            await document.documentElement.requestFullscreen();
            isFullscreen = true;
            fullscreenBtn.textContent = 'â';
          } else {
            await document.exitFullscreen();
            isFullscreen = false;
            fullscreenBtn.textContent = 'â›¶';
          }
        } catch (err) {
          console.error(err);
          alert('æµè§ˆå™¨é˜»æ­¢äº†å…¨å±è¯·æ±‚ï¼Œè¯·æ‰‹åŠ¨å…è®¸ã€‚');
        }
      });
    }

    function buildFolders() {
      const map = new Map();
      images.forEach((img) => {
        map.set(img.dir, (map.get(img.dir) || 0) + 1);
      });
      folders = Array.from(map.entries())
        .map(([dir, count]) => ({ dir, count }))
        .sort((a, b) => a.dir.localeCompare(b.dir));

      folderSelect.innerHTML = '<option value="ALL">å…¨éƒ¨ç›®å½•</option>';
      folders.forEach((f) => {
        const opt = document.createElement('option');
        opt.value = f.dir;
        opt.textContent = f.dir ? `${f.dir} (${f.count})` : `(æ ¹ç›®å½•) (${f.count})`;
        folderSelect.appendChild(opt);
      });
    }

    async function loadImages(showLoading = true) {
      try {
        if (showLoading) setStatus('æ­£åœ¨åŠ è½½ä»“åº“æ ‘...');
        const tree = await fetchTree();
        images = (tree.tree || [])
          .filter((item) => item.type === 'blob' && IMAGE_EXT.test(item.path))
          .filter((item) => !shouldSkip(item.path))
          .map((item) => ({
            path: item.path,
            name: item.path.split('/').pop(),
            dir: item.path.includes('/') ? item.path.slice(0, item.path.lastIndexOf('/')) : '',
          }));

        images.sort((a, b) => a.path.localeCompare(b.path));
        images.forEach((item, idx) => {
          item.idx = idx;
        });
        buildFolders();
        render(images);
      } catch (err) {
        console.error(err);
        setStatus(err.message, true);
      }
    }

    async function uploadSelectedFiles() {
      const files = Array.from(uploadFileInput.files || []);
      if (!files.length) {
        alert('è¯·å…ˆé€‰æ‹©æ–‡ä»¶');
        return;
      }
      const folder = uploadPathInput.value;
      try {
        setStatus('ä¸Šä¼ ä¸­...');
        for (const file of files) {
          const content = await toBase64(file);
          const targetPath = buildTargetPath(folder, file.name);
          await apiRequest({
            action: 'upload',
            path: targetPath,
            content,
            message: `upload ${targetPath}`,
          });
        }
        setStatus('ä¸Šä¼ å®Œæˆï¼Œæ­£åœ¨åˆ·æ–°åˆ—è¡¨...');
        await loadImages(false);
        setStatus(`å…± ${images.length} å¼ å›¾ç‰‡ï¼Œå¯ç‚¹å‡»é¢„è§ˆä¸å¤åˆ¶é“¾æ¥ã€‚`);
        uploadFileInput.value = '';
      } catch (err) {
        console.error(err);
        setStatus(err.message || 'ä¸Šä¼ å¤±è´¥', true);
      }
    }

    async function fetchFileSha(path) {
      const url = `${API_BASE}/api/file?path=${encodeURIComponent(path)}`;
      const res = await fetch(url);
      if (!res.ok) {
        const body = await res.json().catch(() => ({}));
        const hint = body.message || `HTTP ${res.status}`;
        throw new Error(`è·å–æ–‡ä»¶ä¿¡æ¯å¤±è´¥ï¼š${hint}`);
      }
      const data = await res.json();
      return data.sha;
    }

    async function deleteFile(path) {
      const sha = await fetchFileSha(path);
      return apiRequest({
        action: 'delete',
        path,
        sha,
        message: `delete ${path}`,
      });
    }

    async function init() {
      setupLightbox();
      await loadImages();
    }

    filterInput.addEventListener('input', applyFilter);
    resetBtn.addEventListener('click', () => {
      filterInput.value = '';
      folderSelect.value = 'ALL';
      applyFilter();
    });

    folderSelect.addEventListener('change', applyFilter);

    toggleControlsBtn.addEventListener('click', () => {
      lightboxEl.classList.toggle('lightbox-controls-hidden');
      const isHidden = lightboxEl.classList.contains('lightbox-controls-hidden');
      const icon = toggleControlsBtn.querySelector('i');
      if (icon) {
        icon.className = isHidden ? 'fas fa-eye lightbox-icon-outline' : 'fas fa-eye-slash lightbox-icon-outline';
      }
    });

    infoBtn.addEventListener('click', () => {
      if (!infoPanel || !infoContent) return;
      if (currentIndex < 0 || currentIndex >= images.length) return;
      const item = images[currentIndex];
      const dims =
        lbImg.naturalWidth && lbImg.naturalHeight
          ? `${lbImg.naturalWidth} Ã— ${lbImg.naturalHeight}`
          : 'æœªçŸ¥';
      const pagesUrl = `${PAGES_BASE}/${item.path}`;
      const cdnUrl = `${CDN_BASE}/${item.path}`;
      infoContent.innerHTML = `
        æ–‡ä»¶åï¼š${item.name}<br />
        è·¯å¾„ï¼š${item.path}<br />
        ç›®å½•ï¼š${item.dir || '(æ ¹ç›®å½•)'}<br />
        å°ºå¯¸ï¼š${dims}<br />
        Pagesï¼š<a href="${pagesUrl}" target="_blank" rel="noreferrer">æ‰“å¼€</a> <button class="info-copy-btn" data-url="${pagesUrl}">å¤åˆ¶</button><br />
        jsDelivrï¼š<a href="${cdnUrl}" target="_blank" rel="noreferrer">æ‰“å¼€</a> <button class="info-copy-btn" data-url="${cdnUrl}">å¤åˆ¶</button>
      `;
      // æ·»åŠ å¤åˆ¶æŒ‰é’®äº‹ä»¶ç›‘å¬
      infoContent.querySelectorAll('.info-copy-btn').forEach((btn) => {
        btn.addEventListener('click', async (e) => {
          e.stopPropagation();
          const url = btn.dataset.url;
          try {
            await navigator.clipboard.writeText(url);
            const originalText = btn.textContent;
            btn.textContent = 'å·²å¤åˆ¶';
            setTimeout(() => {
              btn.textContent = originalText;
            }, 1500);
          } catch (err) {
            console.error('å¤åˆ¶å¤±è´¥:', err);
          }
        });
      });
      infoPanel.classList.toggle('hidden');
    });

    function openUploadModal() {
      const savedPath = getDefaultUploadPath();
      if (defaultUploadPathInput) {
        defaultUploadPathInput.value = savedPath;
      }
      if (defaultPathDisplay) {
        defaultPathDisplay.textContent = savedPath;
      }
      uploadModal.classList.remove('hidden');
      document.body.style.overflow = 'hidden';
    }

    function closeUploadModal() {
      uploadModal.classList.add('hidden');
      document.body.style.overflow = '';
      uploadFileInput.value = '';
      uploadFileList.innerHTML = '';
      uploadPathInput.value = '';
    }

    function updateFileList() {
      const files = Array.from(uploadFileInput.files || []);
      if (files.length === 0) {
        uploadFileList.innerHTML = '';
        return;
      }
      uploadFileList.innerHTML = '<div class="upload-file-list-title">å·²é€‰æ‹©æ–‡ä»¶ï¼š</div>' +
        files.map((file, index) => `
          <div class="upload-file-item">
            <span class="upload-file-name">${file.name}</span>
            <span class="upload-file-size">(${(file.size / 1024).toFixed(2)} KB)</span>
          </div>
        `).join('');
    }

    openUploadBtn.addEventListener('click', openUploadModal);
    
    uploadModal.addEventListener('click', (e) => {
      if (e.target.dataset.closeUpload !== undefined || e.target.classList.contains('upload-modal-backdrop')) {
        closeUploadModal();
      }
    });

    uploadFileInput.addEventListener('change', updateFileList);

    saveDefaultPathBtn.addEventListener('click', () => {
      const path = defaultUploadPathInput.value.trim();
      if (path) {
        const savedPath = saveDefaultUploadPath(path);
        if (savedPath && defaultPathDisplay) {
          defaultPathDisplay.textContent = savedPath;
          alert('é»˜è®¤è·¯å¾„å·²ä¿å­˜ï¼');
        }
      } else {
        alert('è¯·è¾“å…¥æœ‰æ•ˆçš„è·¯å¾„');
      }
    });

    uploadBtn.addEventListener('click', async () => {
      await uploadSelectedFiles();
      closeUploadModal();
    });

    reloadBtn.addEventListener('click', () => loadImages());

    init();
  </script>
</body>
</html>

