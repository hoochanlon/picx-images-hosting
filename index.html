<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>picx-images-hosting - é™æ€ç´¢å¼•</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/hoochanlon/fonts@refs/heads/main/public/OPPOSans4/result.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
  <link rel="stylesheet" href="./css/global.css" />
  <script src="./config.js"></script>
  <script src="./js/dark-mode.js"></script>
</head>
<body>
  <header class="topbar">
    <div class="brand">
      <span class="emoji">ğŸ–¼ï¸</span>
      <span class="title" id="brand-title" style="cursor: pointer;">picx-images-hosting</span>
    </div>
    <div class="controls">
      <div class="folder-control-group">
        <label for="folder" class="icon-label toggle-control" data-target="folder-control">
          <i class="fas fa-folder"></i>
        </label>
        <div class="custom-select-wrapper collapsible" id="folder-control">
          <div class="custom-select" id="folder-select">
            <div class="custom-select-trigger">
              <span class="custom-select-value">å…¨éƒ¨ç›®å½•</span>
              <i class="fas fa-chevron-down custom-select-arrow"></i>
            </div>
            <div class="custom-select-options" id="folder-options">
              <div class="custom-select-option" data-value="ALL">å…¨éƒ¨ç›®å½•</div>
            </div>
          </div>
          <select id="folder" style="display: none;">
            <option value="ALL">å…¨éƒ¨ç›®å½•</option>
          </select>
        </div>
      </div>
      <label for="filter" class="icon-label toggle-control" data-target="filter-control">
        <i class="fas fa-search"></i>
      </label>
      <div class="collapsible" id="filter-control">
        <input id="filter" type="search" placeholder="è¾“å…¥å…³é”®è¯è¿‡æ»¤" />
      </div>
      <label for="open-upload" class="icon-label">
        <i class="fas fa-cloud-upload-alt"></i>
      </label>
      <button id="open-upload" type="button" style="display: none;"></button>
      <a href="upload.html" class="icon-label">
        <i class="fas fa-tasks"></i>
      </a>
      <label for="reload-btn" class="icon-label">
        <i class="fas fa-sync"></i>
      </label>
      <button id="reload-btn" type="button" style="display: none;"></button>
      <a href="tutorial.html" class="icon-label">
        <i class="fas fa-book"></i>
      </a>
      <button class="dark-mode-toggle icon-label" aria-label="åˆ‡æ¢åˆ°å¤œé—´æ¨¡å¼" title="åˆ‡æ¢åˆ°å¤œé—´æ¨¡å¼">
        <i class="fas fa-moon"></i>
      </button>
      <a id="github-link" href="#" target="_blank" rel="noopener noreferrer" class="icon-label">
        <i class="fab fa-github"></i>
      </a>
    </div>
  </header>

  <main class="container">
    <section id="status" class="status">æ­£åœ¨åŠ è½½ä»“åº“æ ‘...</section>
    <section id="grid" class="grid" aria-live="polite"></section>
  </main>

  <button id="back-to-top" class="back-to-top" aria-label="å›åˆ°é¡¶éƒ¨" title="å›åˆ°é¡¶éƒ¨">
    <i class="fas fa-arrow-up"></i>
  </button>

  <div id="lightbox" class="lightbox hidden" aria-modal="true" role="dialog">
    <div class="lightbox-backdrop" data-close></div>
    <div class="lightbox-body">
      <button class="lightbox-close lightbox-control-btn" aria-label="å…³é—­" data-close>Ã—</button>
      <div class="lightbox-img-wrap">
        <button class="lightbox-nav prev lightbox-control-btn" aria-label="ä¸Šä¸€å¼ ">â†</button>
        <img id="lightbox-img" alt="é¢„è§ˆå¤§å›¾" />
        <button class="lightbox-nav next lightbox-control-btn" aria-label="ä¸‹ä¸€å¼ ">â†’</button>
      </div>
      <div class="lightbox-zoom">
        <button id="toggle-controls" type="button" aria-label="åˆ‡æ¢æ§åˆ¶æŒ‰é’®"><i class="fas fa-eye-slash lightbox-icon-outline"></i></button>
        <button id="info-btn" class="lightbox-control-btn" type="button" aria-label="å›¾ç‰‡ä¿¡æ¯"><i class="fas fa-info-circle lightbox-icon-outline"></i></button>
        <button id="fullscreen-toggle" class="lightbox-control-btn" type="button" aria-label="å…¨å±åˆ‡æ¢">â›¶</button>
        <button id="zoom-reset" class="lightbox-control-btn" type="button">1:1</button>
        <button id="rotate" class="lightbox-control-btn" type="button">âŸ³</button>
      </div>
      <div id="lightbox-info" class="lightbox-info hidden" aria-live="polite">
        <div class="lightbox-info-title">å›¾ç‰‡ä¿¡æ¯</div>
        <div id="lightbox-info-content" class="lightbox-info-code"></div>
      </div>
    </div>
  </div>

  <div id="upload-modal" class="upload-modal hidden" aria-modal="true" role="dialog">
    <div class="upload-modal-backdrop" data-close-upload></div>
    <div class="upload-modal-content">
      <div class="upload-modal-header">
        <h2>ä¸Šä¼ æ–‡ä»¶</h2>
        <button class="upload-modal-close" aria-label="å…³é—­" data-close-upload>Ã—</button>
      </div>
      <div class="upload-modal-body">
        <div class="upload-form-group">
          <label for="upload-file">é€‰æ‹©æ–‡ä»¶ï¼š</label>
          <div class="file-input-wrapper">
            <input id="upload-file" type="file" multiple />
            <button type="button" class="file-input-button" id="file-input-trigger">
              <i class="fas fa-folder-open"></i>
              é€‰æ‹©æ–‡ä»¶
            </button>
            <span class="file-input-text" id="file-input-text">æœªé€‰æ‹©ä»»ä½•æ–‡ä»¶</span>
          </div>
          <div id="upload-file-list" class="upload-file-list" style="display: none;"></div>
        </div>
        <div class="upload-form-group">
          <label for="upload-path">ä¿å­˜åˆ°ï¼š</label>
          <input id="upload-path" type="text" placeholder="ä¾‹å¦‚ imgs/2025/" />
          <p class="upload-tip">è·¯å¾„ç•™ç©ºé»˜è®¤å­˜å…¥ <span id="default-path-display">imgs/uploads/kate/</span></p>
        </div>
        <div class="upload-form-group">
          <label for="default-upload-path">è®¾ç½®é»˜è®¤è·¯å¾„ï¼š</label>
          <div class="default-path-setting">
            <input id="default-upload-path" type="text" placeholder="ä¾‹å¦‚ imgs/uploads/kate/" />
            <button id="save-default-path" type="button" class="btn-secondary">ä¿å­˜</button>
          </div>
          <p class="upload-tip">è®¾ç½®åï¼Œä¸‹æ¬¡ä¸Šä¼ æ—¶è·¯å¾„ç•™ç©ºå°†ä½¿ç”¨æ­¤é»˜è®¤è·¯å¾„</p>
        </div>
        <div class="upload-form-group">
          <p class="upload-tip">æ–‡ä»¶ç» Vercel Serverless è°ƒç”¨ GitHub APIï¼Œå‰ç«¯ä¸å­˜ tokenã€‚</p>
        </div>
      </div>
      <div class="upload-modal-footer">
        <button id="upload-btn" type="button" class="btn-primary">ä¸Šä¼ </button>
        <button id="cancel-upload" type="button" class="btn-secondary" data-close-upload>å–æ¶ˆ</button>
      </div>
    </div>
  </div>

  <template id="card-template">
    <article class="card">
      <div class="meta-top">
        <div class="path" title=""></div>
      </div>
      <div class="thumb">
        <img loading="lazy" alt="" />
      </div>
      <div class="meta">
        <div class="actions-row">
          <button class="btn" type="button" data-copy="pages">é“¾æ¥å¤åˆ¶</button>
          <button class="btn" type="button" data-copy="cdn">CDN å¤åˆ¶</button>
          <button class="btn danger delete-btn" type="button">åˆ é™¤</button>
        </div>
      </div>
    </article>
  </template>

  <script>
    const REPO_OWNER = 'hoochanlon';
    const REPO_NAME = 'picx-images-hosting';
    const BRANCH = 'master';
    const PAGES_BASE = `https://${REPO_OWNER}.github.io/${REPO_NAME}`;
    const CDN_BASE = `https://cdn.jsdelivr.net/gh/${REPO_OWNER}/${REPO_NAME}@${BRANCH}`;
    const IMAGE_EXT = /\.(jpe?g|png|gif|webp|svg)$/i;
    const EXCLUDES = ['.git/', '.github/'];
    // è‡ªåŠ¨æ£€æµ‹ API åŸºç¡€åœ°å€
    // vercel dev è¿è¡Œæ—¶ï¼ˆlocalhost:3000ï¼‰ä½¿ç”¨æœ¬åœ° API
    // GitHub Pages å’Œè‡ªå®šä¹‰åŸŸåä½¿ç”¨ Vercel éƒ¨ç½²çš„ APIï¼ˆå› ä¸º GitHub Pages ä¸æ”¯æŒ Serverless Functionsï¼‰
    // Vercel éƒ¨ç½²ä½¿ç”¨å½“å‰åŸŸå
    const config = window.APP_CONFIG || {
      VERCEL_API_BASE: 'https://picx-images-hosting-brown.vercel.app',
      CUSTOM_DOMAINS: ['blog.hoochanlon.moe'],
      GITHUB_PAGES_PATTERN: /\.github\.io$/,
      DEFAULT_UPLOAD_DIR: 'imgs/uploads/kate/',
      INCLUDED_DIRS: ['imgs']
    };
    
    const isLocalhost = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
    const isVercelDev = isLocalhost && window.location.port === '3000';
    const isGitHubPages = config.GITHUB_PAGES_PATTERN.test(window.location.hostname);
    const isCustomDomain = config.CUSTOM_DOMAINS.includes(window.location.hostname);
    const VERCEL_API_BASE = config.VERCEL_API_BASE;
    
    const API_BASE = isLocalhost && !isVercelDev
      ? VERCEL_API_BASE
      : (isGitHubPages || isCustomDomain)
      ? VERCEL_API_BASE
      : window.location.origin;
    const API_ENDPOINT = `${API_BASE}/api/github`;
    
    // é»˜è®¤ä¸Šä¼ ç›®å½•ï¼Œä»é…ç½®æ–‡ä»¶è¯»å–ï¼Œå¦‚æœæ²¡æœ‰åˆ™ä½¿ç”¨é»˜è®¤å€¼
    const DEFAULT_DIR = config.DEFAULT_UPLOAD_DIR || 'imgs/uploads/kate/';

    const statusEl = document.getElementById('status');
    const gridEl = document.getElementById('grid');
    const filterInput = document.getElementById('filter');
    const folderSelect = document.getElementById('folder');
    const customSelect = document.getElementById('folder-select');
    const customSelectTrigger = customSelect.querySelector('.custom-select-trigger');
    const customSelectValue = customSelect.querySelector('.custom-select-value');
    const customSelectOptions = document.getElementById('folder-options');
    const infoBtn = document.getElementById('info-btn');
    const toggleControlsBtn = document.getElementById('toggle-controls');
    const cardTpl = document.getElementById('card-template');
    const lightboxEl = document.getElementById('lightbox');
    const lbImg = document.getElementById('lightbox-img');
    const infoPanel = document.getElementById('lightbox-info');
    const infoContent = document.getElementById('lightbox-info-content');
    const fullscreenBtn = document.getElementById('fullscreen-toggle');
    const zoomResetBtn = document.getElementById('zoom-reset');
    const rotateBtn = document.getElementById('rotate');
    const openUploadBtn = document.getElementById('open-upload');
    const uploadModal = document.getElementById('upload-modal');
    const uploadFileInput = document.getElementById('upload-file');
    const uploadPathInput = document.getElementById('upload-path');
    const uploadBtn = document.getElementById('upload-btn');
    const uploadFileList = document.getElementById('upload-file-list');
    const defaultUploadPathInput = document.getElementById('default-upload-path');
    const defaultPathDisplay = document.getElementById('default-path-display');
    const saveDefaultPathBtn = document.getElementById('save-default-path');
    const reloadBtn = document.getElementById('reload-btn');

    let images = [];
    let folders = [];
    let currentIndex = -1;
    let displayedCount = 0;
    const ITEMS_PER_PAGE = 100;
    let isLoadingMore = false;
    let scale = 1;
    let rotation = 0;
    let translateX = 0;
    let translateY = 0;
    let isPanning = false;
    let panStartX = 0;
    let panStartY = 0;
    let isFullscreen = false;

    function applyTransform() {
      lbImg.style.transform = `translate(${translateX}px, ${translateY}px) scale(${scale}) rotate(${rotation}deg)`;
    }

    function resetTransform() {
      scale = 1;
      rotation = 0;
      translateX = 0;
      translateY = 0;
      applyTransform();
    }

    function setStatus(text, isError = false) {
      statusEl.textContent = text;
      statusEl.classList.toggle('error', isError);
    }

    function shouldSkip(path) {
      // æ£€æŸ¥æ˜¯å¦åœ¨æ’é™¤åˆ—è¡¨ä¸­
      if (EXCLUDES.some((ex) => path.startsWith(ex))) {
        return true;
      }
      
      // æ£€æŸ¥æ˜¯å¦åœ¨å…è®¸çš„ç›®å½•åˆ—è¡¨ä¸­
      const includedDirs = config.INCLUDED_DIRS || [];
      if (includedDirs.length > 0) {
        // å¦‚æœé…ç½®äº†å…è®¸çš„ç›®å½•ï¼Œåªæ˜¾ç¤ºè¿™äº›ç›®å½•ä¸‹çš„å›¾ç‰‡
        const isIncluded = includedDirs.some(dir => {
          // æ£€æŸ¥è·¯å¾„æ˜¯å¦ä»¥ç›®å½•å¼€å¤´ï¼ˆæ”¯æŒæ ¹ç›®å½•æ–‡ä»¶ï¼‰
          if (dir === '') {
            // ç©ºå­—ç¬¦ä¸²è¡¨ç¤ºæ ¹ç›®å½•ï¼Œæ£€æŸ¥æ˜¯å¦åœ¨æ ¹ç›®å½•ï¼ˆä¸åŒ…å«æ–œæ ï¼‰
            return !path.includes('/');
          }
          return path.startsWith(dir + '/') || path === dir;
        });
        if (!isIncluded) {
          return true;
        }
      }
      
      return false;
    }

    function getDefaultUploadPath() {
      const saved = localStorage.getItem('defaultUploadPath');
      return saved || DEFAULT_DIR;
    }

    function saveDefaultUploadPath(path) {
      if (path && path.trim()) {
        let normalizedPath = path.trim();
        if (!normalizedPath.endsWith('/')) normalizedPath += '/';
        localStorage.setItem('defaultUploadPath', normalizedPath);
        return normalizedPath;
      }
      return null;
    }

    function buildTargetPath(folderInput, fileName) {
      let base = (folderInput || '').trim();
      if (!base) base = getDefaultUploadPath();
      if (!base.endsWith('/')) base += '/';
      return `${base}${fileName}`;
    }

    async function toBase64(file) {
      const buffer = await file.arrayBuffer();
      const bytes = new Uint8Array(buffer);
      let binary = '';
      const chunk = 0x8000;
      for (let i = 0; i < bytes.length; i += chunk) {
        binary += String.fromCharCode(...bytes.subarray(i, i + chunk));
      }
      return btoa(binary);
    }

    async function apiRequest(payload) {
      const res = await fetch(API_ENDPOINT, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload),
      });
      if (!res.ok) {
        const text = await res.text();
        throw new Error(text || `API è¯·æ±‚å¤±è´¥: ${res.status}`);
      }
      return res.json();
    }

    async function fetchTree() {
      const url = `${API_BASE}/api/tree`;
      const res = await fetch(url);
      if (!res.ok) {
        const body = await res.json().catch(() => ({}));
        const hint = body.message || `HTTP ${res.status}`;
        throw new Error(`è·å–ä»“åº“æ ‘å¤±è´¥ï¼š${hint}`);
      }
      return res.json();
    }

    function buildCard(item) {
      const node = cardTpl.content.firstElementChild.cloneNode(true);
      const imgEl = node.querySelector('img');
      const pathEl = node.querySelector('.path');
      const pagesLink = document.createElement('a');
      pagesLink.href = `${PAGES_BASE}/${item.path}`;
      const cdnLink = document.createElement('a');
      cdnLink.href = `${CDN_BASE}/${item.path}`;
      const delBtn = node.querySelector('.delete-btn');
      const copyButtons = node.querySelectorAll('[data-copy]');

      // æ‡’åŠ è½½ï¼šä½¿ç”¨ data-src å­˜å‚¨çœŸå®å›¾ç‰‡åœ°å€ï¼Œå…ˆç”¨ loading.gif ä½œä¸ºå ä½ç¬¦
      const loadingGif = `${CDN_BASE}/imgs/special/loading.gif`;
      imgEl.src = loadingGif;
      imgEl.dataset.src = `${CDN_BASE}/${item.path}`;
      imgEl.alt = item.name;
      imgEl.classList.add('lazy-load');
      pathEl.textContent = item.name;
      pathEl.title = item.path;

      pagesLink.href = `${PAGES_BASE}/${item.path}`;
      cdnLink.href = `${CDN_BASE}/${item.path}`;

      imgEl.addEventListener('click', () => openLightbox(item.idx));
      node.addEventListener('click', (e) => {
        if (e.target.tagName === 'BUTTON' || e.target.tagName === 'A') return;
        openLightbox(item.idx);
      });

      copyButtons.forEach((btn) => {
        btn.addEventListener('click', () => {
          const type = btn.dataset.copy;
          const url = type === 'pages' ? pagesLink.href : cdnLink.href;
          navigator.clipboard.writeText(url);
          const old = btn.textContent;
          btn.textContent = 'å·²å¤åˆ¶';
          setTimeout(() => (btn.textContent = old), 1500);
        });
      });

      delBtn.addEventListener('click', async (e) => {
        e.stopPropagation();
        const ok = confirm(`ç¡®å®šåˆ é™¤æ–‡ä»¶ï¼š${item.path} å—ï¼Ÿæ­¤æ“ä½œä¼šæäº¤åˆ°ä»“åº“ã€‚`);
        if (!ok) return;
        try {
          setStatus('åˆ é™¤ä¸­...');
          await deleteFile(item.path);
          await loadImages(false);
          setStatus('åˆ é™¤å®Œæˆ');
        } catch (err) {
          console.error(err);
          setStatus(err.message || 'åˆ é™¤å¤±è´¥', true);
        }
      });

      return node;
    }

    function render(list, reset = true) {
      if (reset) {
        gridEl.innerHTML = '';
        displayedCount = 0;
      }
      
      if (!list.length) {
        if (reset) {
          setStatus('æœªæ‰¾åˆ°åŒ¹é…çš„å›¾ç‰‡ï¼Œè¯·æ£€æŸ¥è¿‡æ»¤æ¡ä»¶ã€‚', true);
        }
        return;
      }
      
      const total = list.length;
      const toDisplay = Math.min(displayedCount + ITEMS_PER_PAGE, total);
      const itemsToAdd = list.slice(displayedCount, toDisplay);
      
      if (itemsToAdd.length === 0) {
        return;
      }
      
      const frag = document.createDocumentFragment();
      itemsToAdd.forEach((item) => frag.appendChild(buildCard(item)));
      gridEl.appendChild(frag);
      
      // è§‚å¯Ÿæ–°æ·»åŠ çš„å›¾ç‰‡ï¼Œå¯ç”¨æ‡’åŠ è½½
      observeNewImages();
      
      displayedCount = toDisplay;
      
      if (reset) {
        setStatus(`å…± ${total} å¼ å›¾ç‰‡ï¼Œå·²æ˜¾ç¤º ${displayedCount} å¼ ï¼Œå¯ç‚¹å‡»é¢„è§ˆä¸å¤åˆ¶é“¾æ¥ã€‚`);
      } else {
        setStatus(`å…± ${total} å¼ å›¾ç‰‡ï¼Œå·²æ˜¾ç¤º ${displayedCount} å¼ ï¼Œå¯ç‚¹å‡»é¢„è§ˆä¸å¤åˆ¶é“¾æ¥ã€‚`);
      }
      
      // å¦‚æœè¿˜æœ‰æ›´å¤šå›¾ç‰‡ï¼Œæ˜¾ç¤ºåŠ è½½æç¤º
      if (displayedCount < total) {
        showLoadMoreIndicator();
      } else {
        hideLoadMoreIndicator();
      }
    }
    
    function showLoadMoreIndicator() {
      let indicator = document.getElementById('load-more-indicator');
      if (!indicator) {
        indicator = document.createElement('div');
        indicator.id = 'load-more-indicator';
        indicator.className = 'load-more-indicator';
        indicator.textContent = 'æ»šåŠ¨åˆ°åº•éƒ¨åŠ è½½æ›´å¤š...';
        gridEl.appendChild(indicator);
      }
    }
    
    function hideLoadMoreIndicator() {
      const indicator = document.getElementById('load-more-indicator');
      if (indicator) {
        indicator.remove();
      }
    }
    
    function loadMoreImages() {
      if (isLoadingMore) return;
      
      const keyword = filterInput.value.trim().toLowerCase();
      const folder = folderSelect.value;
      
      let list;
      if (!keyword) {
        list = folder === 'ALL' ? images : images.filter((img) => img.dir === folder);
      } else {
        list = images
          .filter((img) => img.path.toLowerCase().includes(keyword))
          .filter((img) => (folder === 'ALL' ? true : img.dir === folder));
      }
      
      if (displayedCount >= list.length) {
        hideLoadMoreIndicator();
        return;
      }
      
      isLoadingMore = true;
      render(list, false);
      isLoadingMore = false;
    }
    
    function setupInfiniteScroll() {
      const backToTopBtn = document.getElementById('back-to-top');
      let scrollTimeout;
      window.addEventListener('scroll', () => {
        if (scrollTimeout) {
          clearTimeout(scrollTimeout);
        }
        
        scrollTimeout = setTimeout(() => {
          const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
          const windowHeight = window.innerHeight;
          const documentHeight = document.documentElement.scrollHeight;
          
          // æ˜¾ç¤º/éšè—å›åˆ°é¡¶éƒ¨æŒ‰é’®
          if (scrollTop > 300) {
            backToTopBtn.classList.add('show');
          } else {
            backToTopBtn.classList.remove('show');
          }
          
          // å½“æ»šåŠ¨åˆ°è·ç¦»åº•éƒ¨ 200px æ—¶å¼€å§‹åŠ è½½
          if (scrollTop + windowHeight >= documentHeight - 200) {
            loadMoreImages();
          }
        }, 100);
      });
      
      // å›åˆ°é¡¶éƒ¨åŠŸèƒ½
      backToTopBtn.addEventListener('click', () => {
        window.scrollTo({
          top: 0,
          behavior: 'smooth'
        });
      });
    }
    
    function setupLazyLoad() {
      const lazyImages = document.querySelectorAll('img.lazy-load');
      
      if ('IntersectionObserver' in window) {
        const imageObserver = new IntersectionObserver((entries, observer) => {
          entries.forEach(entry => {
            if (entry.isIntersecting) {
              const img = entry.target;
              const dataSrc = img.dataset.src;
              
              if (dataSrc) {
                // åˆ›å»ºæ–°çš„ Image å¯¹è±¡æ¥é¢„åŠ è½½
                const imageLoader = new Image();
                imageLoader.onload = () => {
                  img.src = dataSrc;
                  img.classList.remove('lazy-load');
                  img.classList.add('lazy-loaded');
                };
                imageLoader.onerror = () => {
                  // å¦‚æœåŠ è½½å¤±è´¥ï¼Œä¿æŒ loading.gif
                  console.error('Failed to load image:', dataSrc);
                };
                imageLoader.src = dataSrc;
                
                observer.unobserve(img);
              }
            }
          });
        }, {
          rootMargin: '50px' // æå‰50pxå¼€å§‹åŠ è½½
        });
        
        lazyImages.forEach(img => imageObserver.observe(img));
      } else {
        // ä¸æ”¯æŒ IntersectionObserver çš„æµè§ˆå™¨ï¼Œç›´æ¥åŠ è½½æ‰€æœ‰å›¾ç‰‡
        lazyImages.forEach(img => {
          if (img.dataset.src) {
            img.src = img.dataset.src;
            img.classList.remove('lazy-load');
            img.classList.add('lazy-loaded');
          }
        });
      }
    }
    
    function observeNewImages() {
      // è§‚å¯Ÿæ–°æ·»åŠ çš„å›¾ç‰‡
      const newLazyImages = document.querySelectorAll('img.lazy-load:not(.observed)');
      if (newLazyImages.length === 0) return;
      
      if ('IntersectionObserver' in window) {
        const imageObserver = new IntersectionObserver((entries, observer) => {
          entries.forEach(entry => {
            if (entry.isIntersecting) {
              const img = entry.target;
              const dataSrc = img.dataset.src;
              
              if (dataSrc) {
                const imageLoader = new Image();
                imageLoader.onload = () => {
                  img.src = dataSrc;
                  img.classList.remove('lazy-load');
                  img.classList.add('lazy-loaded');
                };
                imageLoader.onerror = () => {
                  console.error('Failed to load image:', dataSrc);
                };
                imageLoader.src = dataSrc;
                
                observer.unobserve(img);
              }
            }
          });
        }, {
          rootMargin: '50px'
        });
        
        newLazyImages.forEach(img => {
          img.classList.add('observed');
          imageObserver.observe(img);
        });
      } else {
        newLazyImages.forEach(img => {
          if (img.dataset.src) {
            img.src = img.dataset.src;
            img.classList.remove('lazy-load');
            img.classList.add('lazy-loaded');
          }
        });
      }
    }

    function applyFilter() {
      const keyword = filterInput.value.trim().toLowerCase();
      const folder = folderSelect.value;
      if (!keyword) {
        const base = folder === 'ALL' ? images : images.filter((img) => img.dir === folder);
        render(base, true);
        return;
      }
      const filtered = images
        .filter((img) => img.path.toLowerCase().includes(keyword))
        .filter((img) => (folder === 'ALL' ? true : img.dir === folder));
      render(filtered, true);
    }

    function openLightbox(idx) {
      if (idx < 0 || idx >= images.length) return;
      currentIndex = idx;
      const item = images[idx];
      const cdnUrl = `${CDN_BASE}/${item.path}`;

      lbImg.src = cdnUrl;
      resetTransform();

      lightboxEl.classList.remove('hidden');
      document.body.classList.add('lightbox-open');
      if (infoPanel) {
        infoPanel.classList.add('hidden');
      }
    }

    function closeLightbox() {
      lightboxEl.classList.add('hidden');
      currentIndex = -1;
      document.body.classList.remove('lightbox-open');
      if (infoPanel) {
        infoPanel.classList.add('hidden');
      }
      // é‡ç½®æ§åˆ¶æŒ‰é’®æ˜¾ç¤ºçŠ¶æ€
      lightboxEl.classList.remove('lightbox-controls-hidden');
      if (toggleControlsBtn) {
        const icon = toggleControlsBtn.querySelector('i');
        if (icon) {
          icon.className = 'fas fa-eye-slash lightbox-icon-outline';
        }
      }
    }

    function showPrev() {
      if (currentIndex <= 0) {
        openLightbox(images.length - 1);
        return;
      }
      openLightbox(currentIndex - 1);
    }

    function showNext() {
      if (currentIndex >= images.length - 1) {
        openLightbox(0);
        return;
      }
      openLightbox(currentIndex + 1);
    }

    function setupLightbox() {
      lightboxEl.addEventListener('click', (e) => {
        const target = e.target;
        if (
          target.dataset.close !== undefined ||
          target.classList.contains('lightbox-backdrop') ||
          target === lightboxEl
        ) {
          closeLightbox();
        }
      });
      lightboxEl.querySelector('.prev').addEventListener('click', (e) => {
        e.stopPropagation();
        showPrev();
      });
      lightboxEl.querySelector('.next').addEventListener('click', (e) => {
        e.stopPropagation();
        showNext();
      });
      lightboxEl.querySelector('.lightbox-close').addEventListener('click', (e) => {
        e.stopPropagation();
        closeLightbox();
      });

      document.addEventListener('keydown', (e) => {
        if (lightboxEl.classList.contains('hidden')) return;
        if (e.key === 'Escape') closeLightbox();
        if (e.key === 'ArrowLeft') showPrev();
        if (e.key === 'ArrowRight') showNext();
      });

      lbImg.addEventListener('wheel', (e) => {
        e.preventDefault();
        const delta = e.deltaY < 0 ? 0.1 : -0.1;
        scale = Math.min(5, Math.max(0.5, scale + delta));
        applyTransform();
      }, { passive: false });

      lbImg.addEventListener('dblclick', () => {
        scale = scale === 1 ? 2 : 1;
        translateX = 0;
        translateY = 0;
        applyTransform();
      });

      lbImg.addEventListener('mousedown', (e) => {
        if (scale <= 1) return;
        isPanning = true;
        panStartX = e.clientX - translateX;
        panStartY = e.clientY - translateY;
        e.preventDefault();
      });

      window.addEventListener('mousemove', (e) => {
        if (!isPanning) return;
        translateX = e.clientX - panStartX;
        translateY = e.clientY - panStartY;
        applyTransform();
      });

      window.addEventListener('mouseup', () => {
        isPanning = false;
      });

      zoomResetBtn.addEventListener('click', () => {
        resetTransform();
      });

      rotateBtn.addEventListener('click', () => {
        rotation = (rotation + 90) % 360;
        applyTransform();
      });

      fullscreenBtn.addEventListener('click', async () => {
        try {
          if (!document.fullscreenElement) {
            await document.documentElement.requestFullscreen();
            isFullscreen = true;
            fullscreenBtn.textContent = 'â';
          } else {
            await document.exitFullscreen();
            isFullscreen = false;
            fullscreenBtn.textContent = 'â›¶';
          }
        } catch (err) {
          console.error(err);
          alert('æµè§ˆå™¨é˜»æ­¢äº†å…¨å±è¯·æ±‚ï¼Œè¯·æ‰‹åŠ¨å…è®¸ã€‚');
        }
      });
    }

    function buildFolders() {
      const map = new Map();
      images.forEach((img) => {
        map.set(img.dir, (map.get(img.dir) || 0) + 1);
      });
      folders = Array.from(map.entries())
        .map(([dir, count]) => ({ dir, count }))
        .sort((a, b) => a.dir.localeCompare(b.dir));

      folderSelect.innerHTML = '<option value="ALL">å…¨éƒ¨ç›®å½•</option>';
      customSelectOptions.innerHTML = '<div class="custom-select-option selected" data-value="ALL">å…¨éƒ¨ç›®å½•</div>';
      
      folders.forEach((f) => {
        const opt = document.createElement('option');
        opt.value = f.dir;
        opt.textContent = f.dir ? `${f.dir} (${f.count})` : `(æ ¹ç›®å½•) (${f.count})`;
        folderSelect.appendChild(opt);
        
        const customOpt = document.createElement('div');
        customOpt.className = 'custom-select-option';
        customOpt.dataset.value = f.dir;
        customOpt.textContent = f.dir ? `${f.dir} (${f.count})` : `(æ ¹ç›®å½•) (${f.count})`;
        customSelectOptions.appendChild(customOpt);
      });
    }

    async function loadImages(showLoading = true) {
      try {
        if (showLoading) setStatus('æ­£åœ¨åŠ è½½ä»“åº“æ ‘...');
        const tree = await fetchTree();
        images = (tree.tree || [])
          .filter((item) => item.type === 'blob' && IMAGE_EXT.test(item.path))
          .filter((item) => !shouldSkip(item.path))
          .map((item) => ({
            path: item.path,
            name: item.path.split('/').pop(),
            dir: item.path.includes('/') ? item.path.slice(0, item.path.lastIndexOf('/')) : '',
          }));

        images.sort((a, b) => a.path.localeCompare(b.path));
        images.forEach((item, idx) => {
          item.idx = idx;
        });
        buildFolders();
        
        // åº”ç”¨å½“å‰çš„è¿‡æ»¤æ¡ä»¶ï¼Œè€Œä¸æ˜¯ç›´æ¥æ¸²æŸ“æ‰€æœ‰å›¾ç‰‡
        applyFilter();
      } catch (err) {
        console.error(err);
        setStatus(err.message, true);
      }
    }

    async function uploadSelectedFiles() {
      const files = Array.from(uploadFileInput.files || []);
      if (!files.length) {
        alert('è¯·å…ˆé€‰æ‹©æ–‡ä»¶');
        return;
      }
      const folder = uploadPathInput.value;
      try {
        setStatus('ä¸Šä¼ ä¸­...');
        for (const file of files) {
          const content = await toBase64(file);
          const targetPath = buildTargetPath(folder, file.name);
          await apiRequest({
            action: 'upload',
            path: targetPath,
            content,
            message: `upload ${targetPath}`,
          });
        }
        setStatus('ä¸Šä¼ å®Œæˆï¼Œæ­£åœ¨åˆ·æ–°åˆ—è¡¨...');
        await loadImages(false);
        setStatus(`å…± ${images.length} å¼ å›¾ç‰‡ï¼Œå¯ç‚¹å‡»é¢„è§ˆä¸å¤åˆ¶é“¾æ¥ã€‚`);
        uploadFileInput.value = '';
      } catch (err) {
        console.error(err);
        setStatus(err.message || 'ä¸Šä¼ å¤±è´¥', true);
      }
    }

    async function fetchFileSha(path) {
      const url = `${API_BASE}/api/file?path=${encodeURIComponent(path)}`;
      const res = await fetch(url);
      if (!res.ok) {
        const body = await res.json().catch(() => ({}));
        const hint = body.message || `HTTP ${res.status}`;
        throw new Error(`è·å–æ–‡ä»¶ä¿¡æ¯å¤±è´¥ï¼š${hint}`);
      }
      const data = await res.json();
      return data.sha;
    }

    async function deleteFile(path) {
      const sha = await fetchFileSha(path);
      return apiRequest({
        action: 'delete',
        path,
        sha,
        message: `delete ${path}`,
      });
    }

    async function init() {
      setupLightbox();
      // ç¡®ä¿åˆå§‹çŠ¶æ€å±•å¼€
      initCollapsible();
      setupInfiniteScroll();
      await loadImages();
      // åŠ è½½å®Œæˆåå†æ¬¡ç¡®ä¿çŠ¶æ€æ­£ç¡®
      initCollapsible();
      setupLazyLoad();
    }

    // å±•å¼€/æ”¶ç¼©åŠŸèƒ½
    function toggleCollapsible(targetId) {
      const target = document.getElementById(targetId);
      const toggle = document.querySelector(`[data-target="${targetId}"]`);
      if (!target || !toggle) return;
      
      const isCollapsed = target.classList.contains('collapsed');
      if (isCollapsed) {
        target.classList.remove('collapsed');
        toggle.classList.add('active');
        localStorage.setItem(`collapsed_${targetId}`, 'false');
      } else {
        target.classList.add('collapsed');
        toggle.classList.remove('active');
        localStorage.setItem(`collapsed_${targetId}`, 'true');
      }
    }

    // åˆå§‹åŒ–å±•å¼€/æ”¶ç¼©çŠ¶æ€
    function initCollapsible() {
      document.querySelectorAll('.collapsible').forEach(el => {
        const targetId = el.id;
        const savedState = localStorage.getItem(`collapsed_${targetId}`);
        const toggle = document.querySelector(`[data-target="${targetId}"]`);
        
        // é»˜è®¤å±•å¼€ï¼Œåªæœ‰æ˜ç¡®ä¿å­˜ä¸º 'true' æ—¶æ‰æ”¶ç¼©
        if (savedState === 'true') {
          el.classList.add('collapsed');
          if (toggle) toggle.classList.remove('active');
        } else {
          // é»˜è®¤å±•å¼€çŠ¶æ€
          el.classList.remove('collapsed');
          if (toggle) toggle.classList.add('active');
        }
      });
    }

    // ç»‘å®šå±•å¼€/æ”¶ç¼©æŒ‰é’®äº‹ä»¶
    document.querySelectorAll('.toggle-control').forEach(toggle => {
      toggle.addEventListener('click', (e) => {
        e.preventDefault();
        const targetId = toggle.dataset.target;
        // å¦‚æœæ˜¯æ–‡ä»¶å¤¹æ§åˆ¶ï¼Œç¡®ä¿ä¸‹æ‹‰æ¡†åœ¨å±•å¼€æ—¶èƒ½æ­£å¸¸å·¥ä½œ
        if (targetId === 'folder-control') {
          const folderControl = document.getElementById('folder-control');
          const isCollapsed = folderControl && folderControl.classList.contains('collapsed');
          toggleCollapsible(targetId);
          // å¦‚æœä»æŠ˜å çŠ¶æ€å±•å¼€ï¼Œç¡®ä¿ä¸‹æ‹‰æ¡†å¯ä»¥æ­£å¸¸æ˜¾ç¤º
          if (isCollapsed && folderControl && !folderControl.classList.contains('collapsed')) {
            // å»¶è¿Ÿä¸€ä¸‹ï¼Œç¡®ä¿åŠ¨ç”»å®Œæˆåå†å…è®¸ä¸‹æ‹‰
            setTimeout(() => {
              // ä¸‹æ‹‰æ¡†ç°åœ¨å¯ä»¥æ­£å¸¸å·¥ä½œäº†
            }, 300);
          }
        } else {
          toggleCollapsible(targetId);
        }
      });
    });

    filterInput.addEventListener('input', applyFilter);

    folderSelect.addEventListener('change', applyFilter);

    // è‡ªå®šä¹‰ä¸‹æ‹‰æ¡†äº‹ä»¶å¤„ç†
    customSelectTrigger.addEventListener('click', (e) => {
      e.stopPropagation();
      // ç¡®ä¿æ–‡ä»¶å¤¹æ§åˆ¶åŒºåŸŸæ˜¯å±•å¼€çš„
      const folderControl = document.getElementById('folder-control');
      if (folderControl && folderControl.classList.contains('collapsed')) {
        folderControl.classList.remove('collapsed');
        const toggle = document.querySelector('[data-target="folder-control"]');
        if (toggle) {
          toggle.classList.add('active');
        }
        localStorage.setItem('collapsed_folder-control', 'false');
        // ç­‰å¾…åŠ¨ç”»å®Œæˆåå†æ˜¾ç¤ºä¸‹æ‹‰é€‰é¡¹
        setTimeout(() => {
          customSelect.classList.toggle('active');
        }, 300);
        return;
      }
      customSelect.classList.toggle('active');
    });

    customSelectOptions.addEventListener('click', (e) => {
      const option = e.target.closest('.custom-select-option');
      if (!option) return;
      
      const value = option.dataset.value;
      folderSelect.value = value;
      customSelectValue.textContent = option.textContent;
      
      // æ›´æ–°é€‰ä¸­çŠ¶æ€
      customSelectOptions.querySelectorAll('.custom-select-option').forEach(opt => {
        opt.classList.remove('selected');
      });
      option.classList.add('selected');
      
      customSelect.classList.remove('active');
      applyFilter();
    });

    // ç‚¹å‡»å¤–éƒ¨å…³é—­ä¸‹æ‹‰æ¡†
    document.addEventListener('click', (e) => {
      const folderControl = document.getElementById('folder-control');
      // å¦‚æœç‚¹å‡»çš„ä¸æ˜¯ä¸‹æ‹‰æ¡†å†…çš„å…ƒç´ ï¼Œå…³é—­ä¸‹æ‹‰æ¡†
      if (!customSelect.contains(e.target) && !e.target.closest('.folder-control-group')) {
        customSelect.classList.remove('active');
      }
    });

    toggleControlsBtn.addEventListener('click', () => {
      lightboxEl.classList.toggle('lightbox-controls-hidden');
      const isHidden = lightboxEl.classList.contains('lightbox-controls-hidden');
      const icon = toggleControlsBtn.querySelector('i');
      if (icon) {
        icon.className = isHidden ? 'fas fa-eye lightbox-icon-outline' : 'fas fa-eye-slash lightbox-icon-outline';
      }
    });

    infoBtn.addEventListener('click', () => {
      if (!infoPanel || !infoContent) return;
      if (currentIndex < 0 || currentIndex >= images.length) return;
      const item = images[currentIndex];
      const dims =
        lbImg.naturalWidth && lbImg.naturalHeight
          ? `${lbImg.naturalWidth} Ã— ${lbImg.naturalHeight}`
          : 'æœªçŸ¥';
      const pagesUrl = `${PAGES_BASE}/${item.path}`;
      const cdnUrl = `${CDN_BASE}/${item.path}`;
      infoContent.innerHTML = `
        æ–‡ä»¶åï¼š${item.name}<br />
        è·¯å¾„ï¼š${item.path}<br />
        ç›®å½•ï¼š${item.dir || '(æ ¹ç›®å½•)'}<br />
        å°ºå¯¸ï¼š${dims}<br />
        Pagesï¼š<a href="${pagesUrl}" target="_blank" rel="noreferrer">æ‰“å¼€</a> <button class="info-copy-btn" data-url="${pagesUrl}">å¤åˆ¶</button><br />
        jsDelivrï¼š<a href="${cdnUrl}" target="_blank" rel="noreferrer">æ‰“å¼€</a> <button class="info-copy-btn" data-url="${cdnUrl}">å¤åˆ¶</button>
      `;
      // æ·»åŠ å¤åˆ¶æŒ‰é’®äº‹ä»¶ç›‘å¬
      infoContent.querySelectorAll('.info-copy-btn').forEach((btn) => {
        btn.addEventListener('click', async (e) => {
          e.stopPropagation();
          const url = btn.dataset.url;
          try {
            await navigator.clipboard.writeText(url);
            const originalText = btn.textContent;
            btn.textContent = 'å·²å¤åˆ¶';
            setTimeout(() => {
              btn.textContent = originalText;
            }, 1500);
          } catch (err) {
            console.error('å¤åˆ¶å¤±è´¥:', err);
          }
        });
      });
      infoPanel.classList.toggle('hidden');
    });

    function openUploadModal() {
      const savedPath = getDefaultUploadPath();
      if (defaultUploadPathInput) {
        defaultUploadPathInput.value = savedPath;
      }
      if (defaultPathDisplay) {
        defaultPathDisplay.textContent = savedPath;
      }
      uploadModal.classList.remove('hidden');
      document.body.style.overflow = 'hidden';
    }

    function closeUploadModal() {
      uploadModal.classList.add('hidden');
      document.body.style.overflow = '';
      uploadFileInput.value = '';
      uploadFileList.innerHTML = '';
      uploadFileList.style.display = 'none';
      uploadPathInput.value = '';
      const fileInputText = document.getElementById('file-input-text');
      if (fileInputText) {
        fileInputText.textContent = 'æœªé€‰æ‹©ä»»ä½•æ–‡ä»¶';
      }
    }

    function updateFileList() {
      const files = Array.from(uploadFileInput.files || []);
      const fileInputText = document.getElementById('file-input-text');
      
      if (files.length === 0) {
        uploadFileList.innerHTML = '';
        uploadFileList.style.display = 'none';
        if (fileInputText) {
          fileInputText.textContent = 'æœªé€‰æ‹©ä»»ä½•æ–‡ä»¶';
        }
        return;
      }
      
      // æ›´æ–°æ–‡ä»¶é€‰æ‹©æç¤ºæ–‡æœ¬
      if (fileInputText) {
        fileInputText.textContent = `å·²é€‰æ‹© ${files.length} ä¸ªæ–‡ä»¶`;
      }
      
      // æ˜¾ç¤ºæ–‡ä»¶åˆ—è¡¨
      uploadFileList.style.display = 'block';
      uploadFileList.innerHTML = '<div class="upload-file-list-title">å·²é€‰æ‹©æ–‡ä»¶ï¼š</div>' +
        files.map((file, index) => `
          <div class="upload-file-item">
            <span class="upload-file-name">${file.name}</span>
            <span class="upload-file-size">(${(file.size / 1024).toFixed(2)} KB)</span>
          </div>
        `).join('');
    }

    openUploadBtn.addEventListener('click', openUploadModal);
    
    uploadModal.addEventListener('click', (e) => {
      if (e.target.dataset.closeUpload !== undefined || e.target.classList.contains('upload-modal-backdrop')) {
        closeUploadModal();
      }
    });

    uploadFileInput.addEventListener('change', updateFileList);
    
    // è‡ªå®šä¹‰æ–‡ä»¶é€‰æ‹©æŒ‰é’®
    const fileInputTrigger = document.getElementById('file-input-trigger');
    if (fileInputTrigger) {
      fileInputTrigger.addEventListener('click', () => {
        uploadFileInput.click();
      });
    }

    saveDefaultPathBtn.addEventListener('click', () => {
      const path = defaultUploadPathInput.value.trim();
      if (path) {
        const savedPath = saveDefaultUploadPath(path);
        if (savedPath && defaultPathDisplay) {
          defaultPathDisplay.textContent = savedPath;
          alert('é»˜è®¤è·¯å¾„å·²ä¿å­˜ï¼');
        }
      } else {
        alert('è¯·è¾“å…¥æœ‰æ•ˆçš„è·¯å¾„');
      }
    });

    uploadBtn.addEventListener('click', async () => {
      await uploadSelectedFiles();
      closeUploadModal();
    });

    reloadBtn.addEventListener('click', async () => {
      // ä¿å­˜å½“å‰çš„è¿‡æ»¤æ¡ä»¶
      const currentFolder = folderSelect.value;
      const currentKeyword = filterInput.value.trim().toLowerCase();
      
      // é‡æ–°åŠ è½½å›¾ç‰‡
      await loadImages();
      
      // æ¢å¤è¿‡æ»¤æ¡ä»¶
      folderSelect.value = currentFolder;
      filterInput.value = currentKeyword;
      
      // åº”ç”¨è¿‡æ»¤æ¡ä»¶
      applyFilter();
    });
    
    // è®¾ç½® GitHub é“¾æ¥
    const githubLink = document.getElementById('github-link');
    if (githubLink) {
      githubLink.href = config.GITHUB_REPO_URL || 'https://github.com/hoochanlon/picx-images-hosting';
    }

    // æ ‡é¢˜ç‚¹å‡»å®Œå…¨åˆ·æ–°
    const brandTitle = document.getElementById('brand-title');
    brandTitle.addEventListener('click', async () => {
      // é‡ç½®æ‰€æœ‰è¿‡æ»¤æ¡ä»¶
      folderSelect.value = 'ALL';
      filterInput.value = '';
      
      // æ›´æ–°è‡ªå®šä¹‰ä¸‹æ‹‰æ¡†æ˜¾ç¤º
      const customSelectValue = document.querySelector('.custom-select-value');
      if (customSelectValue) {
        customSelectValue.textContent = 'å…¨éƒ¨ç›®å½•';
      }
      const customSelectOptions = document.querySelectorAll('.custom-select-option');
      customSelectOptions.forEach(opt => opt.classList.remove('selected'));
      const allOption = Array.from(customSelectOptions).find(opt => opt.dataset.value === 'ALL');
      if (allOption) {
        allOption.classList.add('selected');
      }
      
      // é‡æ–°åŠ è½½å›¾ç‰‡ï¼ˆä¼šåº”ç”¨è¿‡æ»¤æ¡ä»¶ï¼Œæ­¤æ—¶æ˜¯å…¨éƒ¨ï¼‰
      await loadImages();
    });

    init();
  </script>
</body>
</html>

